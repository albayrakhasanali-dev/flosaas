generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// REFERANS (LOOKUP) TABLOLARI
// ==========================================

model T_Sirket {
  id         Int            @id @default(autoincrement())
  sirketAdi  String         @unique @map("sirket_adi")
  createdAt  DateTime       @default(now()) @map("created_at")
  araclar    T_Arac_Master[]
  kullanicilar User[]

  @@map("t_sirket")
}

model T_Lokasyon {
  id            Int            @id @default(autoincrement())
  lokasyonAdi   String         @unique @map("lokasyon_adi")
  sorumluEmail  String?        @map("sorumlu_email")
  createdAt     DateTime       @default(now()) @map("created_at")
  araclar       T_Arac_Master[]
  kullanicilar  User[]

  @@map("t_lokasyon")
}

model T_Durum {
  id        Int            @id @default(autoincrement())
  durumAdi  String         @unique @map("durum_adi")
  createdAt DateTime       @default(now()) @map("created_at")
  araclar   T_Arac_Master[]

  @@map("t_durum")
}

// ==========================================
// ANA VERİ TABLOSU
// ==========================================

model T_Arac_Master {
  id                    Int       @id @default(autoincrement())
  plaka                 String    @unique
  durumId               Int?      @map("durum_id")
  durum                 T_Durum?  @relation(fields: [durumId], references: [id])
  sirketId              Int?      @map("sirket_id")
  sirket                T_Sirket? @relation(fields: [sirketId], references: [id])
  lokasyonId            Int?      @map("lokasyon_id")
  lokasyon              T_Lokasyon? @relation(fields: [lokasyonId], references: [id])
  mulkiyetTipi          String?   @map("mulkiyet_tipi") // Özmal, Kiralık
  markaModelTicariAdi   String?   @map("marka_model_ticari_adi")
  kullanimSekli         String?   @map("kullanim_sekli")
  modelYili             Int?      @map("model_yili")
  kapasite              String?
  aracMarka             String?   @map("arac_marka")
  kasaMarka             String?   @map("kasa_marka")
  sasiNo                String?   @map("sasi_no")
  motorNo               String?   @map("motor_no")
  guncelKmSaat          Float?    @map("guncel_km_saat")
  zimmetMasrafMerkezi   String?   @map("zimmet_masraf_merkezi")
  uttsDurum             String?   @map("utts_durum") // Takılı, Eksik, Bilinmiyor
  seyirTakipCihazNo     String?   @map("seyir_takip_cihaz_no")
  hgsEtiketNo           String?   @map("hgs_etiket_no")
  hgsSinif              Int?      @map("hgs_sinif")
  otomatikVar           Boolean?  @map("otomatik_var") // VAR/YOK
  otomatikFirma         String?   @map("otomatik_firma")
  otomatikKod           String?   @map("otomatik_kod")
  etiketSinifi          Int?      @map("etiket_sinifi") // 1-6
  hgsKimeAit            String?   @map("hgs_kime_ait")
  takograf              String?   @map("takograf") // var, yok
  taahhutname           String?   @map("taahhutname") // var, yok
  kabisVar              Boolean?  @map("kabis_var")
  kabisSirket           String?   @map("kabis_sirket")
  tescilTarihi          DateTime? @map("tescil_tarihi")
  muayeneBitisTarihi    DateTime? @map("muayene_bitis_tarihi")
  sigortaBitisTarihi    DateTime? @map("sigorta_bitis_tarihi")
  kaskoBitisTarihi      DateTime? @map("kasko_bitis_tarihi")
  aracKimligi           String?   @map("arac_kimligi")
  ruhsatSeriNo          String?   @map("ruhsat_seri_no")
  aciklamaNot           String?   @map("aciklama_not")
  k1YetkiBelgesi        String?   @map("k1_yetki_belgesi") // var, yok
  muayeneGerekli        Boolean   @default(true) @map("muayene_gerekli")
  sigortaGerekli        Boolean   @default(true) @map("sigorta_gerekli")
  tekerSayisi           Int?      @map("teker_sayisi")
  aracKategorisi        String?   @map("arac_kategorisi")
  belgelerDosyalar      String?   @map("belgeler_dosyalar") // JSON array of file paths
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  belgeler              T_Belge[]
  cezalar               T_Ceza[]
  muayeneler            T_Muayene[]
  sigortalar            T_Sigorta[]
  yapilacaklar          T_Yapilacak[]

  @@map("t_arac_master")
}

// ==========================================
// BELGE (DOSYA) YÖNETİMİ
// ==========================================

model T_Belge {
  id          Int            @id @default(autoincrement())
  aracId      Int            @map("arac_id")
  arac        T_Arac_Master  @relation(fields: [aracId], references: [id], onDelete: Cascade)
  belgeTipi   String         @map("belge_tipi") // ruhsat, sigorta, kasko, muayene, diger
  dosyaAdi    String         @map("dosya_adi")
  dosyaBoyut  Int            @map("dosya_boyut") // bytes
  mimeType    String         @map("mime_type")
  icerik      Bytes          @map("icerik") // binary file content
  yukleyenId  Int?           @map("yukleyen_id")
  aciklama    String?
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("t_belge")
}

// ==========================================
// TRAFİK CEZASI TAKİP
// ==========================================

model T_Ceza {
  id              Int            @id @default(autoincrement())
  aracId          Int            @map("arac_id")
  arac            T_Arac_Master  @relation(fields: [aracId], references: [id], onDelete: Cascade)
  tutanakNo       String?        @map("tutanak_no")        // TA-05116049
  cezaTarihi      DateTime       @map("ceza_tarihi")
  tebligTarihi    DateTime?      @map("teblig_tarihi")
  sonOdemeTarihi  DateTime?      @map("son_odeme_tarihi")
  cezaTuru        String         @map("ceza_turu")         // hiz, park, kirmizi_isik, diger
  aciklama        String?                                   // Ceza detay aciklamasi
  cezaTutari      Float          @map("ceza_tutari")       // TL
  indirimlitutar  Float?         @map("indirimli_tutar")   // Erken odeme indirimi
  odemeDurumu     String         @default("odenmedi") @map("odeme_durumu") // odenmedi, odendi, itiraz_edildi
  odemeTarihi     DateTime?      @map("odeme_tarihi")
  tahsilatYontemi String?        @map("tahsilat_yontemi")  // sirket_odedi, maas_kesinti, sofor_odedi, diger
  tahsilatNotu    String?        @map("tahsilat_notu")     // Tahsilat aciklamasi
  dekontDosyaId   Int?           @map("dekont_dosya_id")   // T_Belge referansi (dekont PDF)
  sorumluKisi     String?        @map("sorumlu_kisi")      // Surucu / sorumlu adi
  sorumluTc       String?        @map("sorumlu_tc")        // TC kimlik (opsiyonel)
  plaka           String?                                   // Ceza anindaki plaka
  ihlalYeri       String?        @map("ihlal_yeri")        // Cezanin kesildigi yer
  ihlalHizi       Int?           @map("ihlal_hizi")        // Hiz ihlali durumunda km/h
  sinirHizi       Int?           @map("sinir_hizi")        // Hiz siniri km/h
  itirazDurumu    String?        @map("itiraz_durumu")     // yapilmadi, yapildi, kabul, red
  itirazTarihi    DateTime?      @map("itiraz_tarihi")
  itirazNotu      String?        @map("itiraz_notu")
  kaynakKurum     String?        @map("kaynak_kurum")      // EGM, Belediye, Jandarma
  tutanakDosyaId  Int?           @map("tutanak_dosya_id")  // T_Belge referansi (tutanak PDF)
  ekleyenId       Int?           @map("ekleyen_id")
  notlar          String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("t_ceza")
}

// ==========================================
// MUAYENE (ARAÇ MUAYENESİ) TAKİP
// ==========================================

model T_Muayene {
  id                    Int            @id @default(autoincrement())
  aracId                Int            @map("arac_id")
  arac                  T_Arac_Master  @relation(fields: [aracId], references: [id], onDelete: Cascade)
  muayeneTarihi         DateTime       @map("muayene_tarihi")
  gecerlilikBitisTarihi DateTime       @map("gecerlilik_bitis_tarihi")
  sonuc                 String         // gecti, kaldi
  muayeneIstasyonu      String?        @map("muayene_istasyonu")
  muayeneIstasyonuIl    String?        @map("muayene_istasyonu_il")
  raporNo               String?        @map("rapor_no")
  muayeneTipi           String         @default("periyodik") @map("muayene_tipi") // periyodik, ek_muayene, ozel
  muayeneUcreti         Float?         @map("muayene_ucreti")
  basarisizNeden        String?        @map("basarisiz_neden") // fren, egzoz, aydinlatma, lastik, sasi, diger
  basarisizDetay        String?        @map("basarisiz_detay")
  raporDosyaId          Int?           @map("rapor_dosya_id")
  ekleyenId             Int?           @map("ekleyen_id")
  notlar                String?
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  @@map("t_muayene")
}

// ==========================================
// SİGORTA TAKİP
// ==========================================

model T_Sigorta {
  id                  Int            @id @default(autoincrement())
  aracId              Int            @map("arac_id")
  arac                T_Arac_Master  @relation(fields: [aracId], references: [id], onDelete: Cascade)
  sigortaTuru         String         @map("sigorta_turu")        // trafik, kasko, imm
  policeNo            String?        @map("police_no")
  sigortaSirketi      String?        @map("sigorta_sirketi")
  acenteAdi           String?        @map("acente_adi")
  acenteTelefon       String?        @map("acente_telefon")
  baslangicTarihi     DateTime       @map("baslangic_tarihi")
  bitisTarihi         DateTime       @map("bitis_tarihi")
  primTutari          Float?         @map("prim_tutari")
  odemeSekli          String?        @map("odeme_sekli")         // pesin, taksit
  taksitSayisi        Int?           @map("taksit_sayisi")
  odemeDurumu         String         @default("odenmedi") @map("odeme_durumu") // odenmedi, odendi, kismen_odendi
  odemeTarihi         DateTime?      @map("odeme_tarihi")
  policeDosyaId       Int?           @map("police_dosya_id")
  teminatBilgi        String?        @map("teminat_bilgi")
  ekleyenId           Int?           @map("ekleyen_id")
  notlar              String?
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  @@map("t_sigorta")
}

// ==========================================
// KULLANICI & ROL YÖNETİMİ (RBAC)
// ==========================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("lokasyon_sefi") // super_admin, sirket_yoneticisi, lokasyon_sefi
  sirketId      Int?      @map("sirket_id")
  sirket        T_Sirket? @relation(fields: [sirketId], references: [id])
  lokasyonId    Int?      @map("lokasyon_id")
  lokasyon      T_Lokasyon? @relation(fields: [lokasyonId], references: [id])
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  atananGorevler    T_Yapilacak[] @relation("atananGorevler")
  eklenenGorevler   T_Yapilacak[] @relation("eklenenGorevler")

  @@map("users")
}

// ==========================================
// YAPILACAKLAR (İŞ TAKİP / TO-DO)
// ==========================================

model T_Yapilacak {
  id                  Int            @id @default(autoincrement())
  baslik              String         @map("baslik")
  aciklama            String?        @map("aciklama")
  durum               String         @default("acik") @map("durum")       // acik, devam_ediyor, tamamlandi, iptal
  oncelik             String         @default("normal") @map("oncelik")   // dusuk, normal, yuksek, kritik

  aracId              Int?           @map("arac_id")
  arac                T_Arac_Master? @relation(fields: [aracId], references: [id], onDelete: SetNull)

  atananKullaniciId   Int?           @map("atanan_kullanici_id")
  atanan              User?          @relation("atananGorevler", fields: [atananKullaniciId], references: [id])

  sonTarih            DateTime?      @map("son_tarih")
  tamamlanmaTarihi    DateTime?      @map("tamamlanma_tarihi")

  kategori            String?        @map("kategori")     // bakim, transfer, idari, diger

  ekleyenId           Int?           @map("ekleyen_id")
  ekleyen             User?          @relation("eklenenGorevler", fields: [ekleyenId], references: [id])

  notlar              String?        @map("notlar")

  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  @@map("t_yapilacak")
}

// ==========================================
// OTOMASYON LOG
// ==========================================

model CronLog {
  id          Int      @id @default(autoincrement())
  jobName     String   @map("job_name")
  status      String   // success, error
  message     String?
  affectedCount Int?   @map("affected_count")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("cron_logs")
}
